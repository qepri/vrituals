"use strict";(self.webpackChunkfront_simple=self.webpackChunkfront_simple||[]).push([[78],{9078:(P,f,r)=>{r.r(f),r.d(f,{default:()=>b});var s=r(467),t=r(4438),v=r(33),d=r(9052),m=r(8800),C=r(1774),R=r(1413),u=r(4843),y=r(6977),E=r(5964),I=r(6852),M=r(7120);let S=(()=>{class a{static{this.\u0275fac=function(n){return new(n||a)}}static{this.\u0275cmp=t.VBU({type:a,selectors:[["app-zen-loader"]],standalone:!0,features:[t.aNF],decls:1,vars:0,consts:[[1,"loader"]],template:function(n,o){1&n&&t.nrm(0,"span",0)},styles:['.loader[_ngcontent-%COMP%]{display:inline-block;transform:translateZ(1px)}.loader[_ngcontent-%COMP%]:after{content:"";display:inline-block;width:48px;height:48px;margin:8px;border-radius:50%;background:var(--primary);animation:_ngcontent-%COMP%_coin-flip 2.4s cubic-bezier(0,.2,.8,1) infinite}@keyframes _ngcontent-%COMP%_coin-flip{0%,to{animation-timing-function:cubic-bezier(.5,0,1,.5)}0%{transform:rotateY(0)}50%{transform:rotateY(1800deg);animation-timing-function:cubic-bezier(0,.5,.5,1)}to{transform:rotateY(3600deg)}}']})}}return a})();var g=r(4909);function x(a,h){1&a&&(t.j41(0,"section",0)(1,"div",1),t.nrm(2,"app-zen-loader"),t.k0s(),t.j41(3,"p",2),t.EFF(4),t.nI1(5,"translate"),t.k0s()()),2&a&&(t.R7$(4),t.SpI(" ",t.bMT(5,1,"CHAT.LOADING")," "))}function T(a,h){if(1&a){const e=t.RV6();t.j41(0,"div",3)(1,"div",4),t.nrm(2,"i",5),t.EFF(3),t.k0s(),t.j41(4,"button",6),t.bIt("click",function(){t.eBV(e);const o=t.XpG();return t.Njj(o.loadInitialData())}),t.nrm(5,"i",7),t.EFF(6),t.nI1(7,"translate"),t.k0s()()}if(2&a){const e=t.XpG();t.R7$(3),t.SpI(" ",e.loadingError()," "),t.R7$(3),t.SpI(" ",t.bMT(7,2,"COMMON.RETRY")," ")}}function L(a,h){1&a&&(t.j41(0,"div",3)(1,"div",8),t.nrm(2,"i",5),t.EFF(3),t.nI1(4,"translate"),t.k0s(),t.j41(5,"button",9),t.nrm(6,"i",10),t.EFF(7),t.nI1(8,"translate"),t.k0s()()),2&a&&(t.R7$(3),t.SpI(" ",t.bMT(4,2,"COMMON.ERROR")," "),t.R7$(4),t.SpI(" ",t.bMT(8,4,"COMMON.BACK")," "))}function F(a,h){if(1&a){const e=t.RV6();t.j41(0,"app-chat-ui",11),t.bIt("conversationIdChange",function(o){t.eBV(e);const i=t.XpG();return t.Njj(i.updateConversation(o))})("sendMessageEvent",function(o){t.eBV(e);const i=t.XpG();return t.Njj(i.handleSendMessage(o))}),t.k0s()}if(2&a){const e=t.XpG();t.Y8G("selectedRole",e.selectedRole())("roleInfo",e.selectedRole())("conversationId",e.conversationId())("currentConversation",e.currentConversation())}}let b=(()=>{class a{constructor(){this.route=(0,t.WQX)(v.nX),this.router=(0,t.WQX)(v.Ix),this.layout=(0,t.WQX)(I.v1),this.groqChatService=(0,t.WQX)(m.vh),this.chatStateService=(0,t.WQX)(M.l),this.conversationService=(0,t.WQX)(m.rP),this.destroy$=new R.B,this.MESSAGE_DEBOUNCE_TIME=550,this.MAX_RETRIES=3,this.chatUiComponent=(0,t.ebz)(d.oL),this.state=(0,t.vPA)({selectedRole:null,conversationId:void 0,currentConversation:null,isLoading:!0,error:null}),this.isLoading=(0,t.EWP)(()=>this.state().isLoading),this.loadingError=(0,t.EWP)(()=>this.state().error),this.selectedRole=(0,t.EWP)(()=>this.state().selectedRole),this.conversationId=(0,t.EWP)(()=>this.state().conversationId),this.currentConversation=(0,t.EWP)(()=>this.state().currentConversation)}ngOnInit(){this.initializeRouteSubscription()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initializeRouteSubscription(){var e=this;this.route.paramMap.pipe((0,y.Q)(this.destroy$),(0,E.p)(n=>n.has("roleId")||n.has("id"))).subscribe((0,s.A)(function*(){yield e.loadInitialData()}))}loadInitialData(){var e=this;return(0,s.A)(function*(){try{e.updateState({isLoading:!0,error:null});const{roleId:n,conversationId:o}=yield e.getRouteParams(),i=e.findRole(n);if(!i)throw new Error(`Role with ID ${n} not found`);yield e.initializeChat(i.fullRole,o)}catch(n){e.handleLoadError(n)}})()}getRouteParams(){var e=this;return(0,s.A)(function*(){const n=yield(0,u._)(e.route.params);return{roleId:+n.roleId,conversationId:n.id}})()}findRole(e){return this.layout.chatBotRoles().find(n=>n.value===e)}initializeChat(e,n){var o=this;return(0,s.A)(function*(){n?yield o.loadExistingChat(e,n):yield o.initializeNewChat(e)})()}initializeNewChat(e){var n=this;return(0,s.A)(function*(){const o=n.conversationService.generateConversationId();n.updateState({selectedRole:e,conversationId:o,currentConversation:null,isLoading:!1}),n.chatStateService.setNeedsFetch(!0)})()}loadExistingChat(e,n){var o=this;return(0,s.A)(function*(){let A,c=0;for(;c<3;)try{const l=yield(0,u._)(o.groqChatService.getConversation(n));return void o.updateState({selectedRole:e,conversationId:n,currentConversation:"data"in l?l.data:l,isLoading:!1})}catch(l){if(A=l,c++,c<3){const p=1e3*Math.pow(2,c-1);yield new Promise(O=>setTimeout(O,p));continue}throw console.error("Failed to fetch conversation after 3 attempts:",l),o.updateState({isLoading:!1,error:"Failed to load conversation. Please try again."}),l}})()}handleLoadError(e){console.error("Error loading initial data:",e),this.updateState({selectedRole:null,currentConversation:null,isLoading:!1,error:e instanceof Error?e.message:"Failed to load chat data"})}updateState(e){this.state.update(n=>({...n,...e}))}updateConversation(e){const n=this.selectedRole();n&&(this.router.navigate([C.S.CHAT,n.id,e],{replaceUrl:!0,skipLocationChange:!0,state:{noReload:!0}}),this.updateState({conversationId:e}))}handleSendMessage(e){var n=this;return(0,s.A)(function*(){const o=n.chatUiComponent();if(o&&n.selectedRole())try{const i=yield n.sendMessageWithRetry(e);n.handleMessageResponse(i,o)}catch(i){n.handleMessageError(i,e,o)}})()}sendMessageWithRetry(e,n=0){var o=this;return(0,s.A)(function*(){try{return yield(0,u._)(o.groqChatService.chat({message:e,role:o.selectedRole(),conversationId:o.conversationId()}))}catch(i){if(n<o.MAX_RETRIES)return yield new Promise(c=>setTimeout(c,1e3*Math.pow(2,n))),o.sendMessageWithRetry(e,n+1);throw i}})()}handleMessageResponse(e,n){const o="data"in e?e.data:e;n.addBotMessage(o.response),o.isLastRequest&&n.setErrorMessage("This is your last free request for today. Upgrade to pro for professional use."),this.updateConversationUrl(o.conversationId)}handleMessageError(e,n,o){429===e?.status?(o.setErrorMessage("Daily request limit reached. Upgrade to pro account for professional use."),o.setLimitReached(!0)):o.addBotMessage("Sorry, there was an error processing your request.",!0)}updateConversationUrl(e){const n=this.selectedRole();n&&(this.router.navigate([C.S.CHAT,n.id,e],{replaceUrl:!0}),this.updateState({conversationId:e}))}static{this.\u0275fac=function(n){return new(n||a)}}static{this.\u0275cmp=t.VBU({type:a,selectors:[["app-chat"]],viewQuery:function(n,o){1&n&&t.wEZ(o.chatUiComponent,d.oL,5),2&n&&t.NyB()},standalone:!0,features:[t.aNF],decls:4,vars:1,consts:[[1,"container","text-center"],[1,"flex-grow-1","d-flex","justify-content-center","align-items-center",2,"margin-top","30vh"],[1,"mt-3"],[1,"error-container"],[1,"alert","alert-danger"],[1,"fa-solid","fa-triangle-exclamation","me-2"],[1,"btn","btn-primary","mt-3",3,"click"],[1,"fa-solid","fa-rotate","me-2"],[1,"alert","alert-warning"],["routerLink","/dashboard",1,"btn","btn-primary","mt-3"],[1,"fa-solid","fa-arrow-left","me-2"],[3,"conversationIdChange","sendMessageEvent","selectedRole","roleInfo","conversationId","currentConversation"]],template:function(n,o){1&n&&t.DNE(0,x,6,3,"section",0)(1,T,8,4)(2,L,9,6)(3,F,1,4),2&n&&t.vxM(0,o.isLoading()?0:o.loadingError()?1:null===o.selectedRole()?2:3)},dependencies:[d.oL,S,g.h,g.D9],encapsulation:2})}}return a})()}}]);